permissions:
  contents: read
on:
  workflow_call:
    inputs:
      ubuntu_packages:
        type: string
        required: false
        default: ""
      toolchains:
        type: string
        required: false
        default: '["stable"]'
      features:
        type: string
        required: false
        default: '["default"]'
      extra_script_path:
        type: string
        default: ".github/ci-scripts/extra.sh"
        required: false
      runner:
        type: string
        required: true
      fireblocks:
        type: boolean
        default: false
        required: false
      args:
        type: string
        default: ""
        required: false
      rustlog:
        type: string
        default: "info"
        required: false
env:
  MEMO: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} ${{ github.job }}"
  JOB_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  RUST_LOG: "${{ inputs.rustlog || 'info' }}"
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
name: test
jobs:
  coverage:
    runs-on: ${{ inputs.runner }}
    name: coverage / ${{ matrix.features }}
    strategy:
      fail-fast: false
      matrix:
        toolchain: ${{ fromJSON(inputs.toolchains) }}
        features: ${{ fromJSON(inputs.features) }}
    steps:
      - name: Init
        uses: carteramesh/ci/.github/actions/rust-init@main
        with:
          ubuntu_packages: ${{ inputs.ubuntu_packages }}
      - name: llvm-tools
        shell: bash
        run: |
          rustup default ${{ matrix.toolchain }}
          rustup component add llvm-tools-preview
          cargo install cargo-llvm-cov
      - name: cargo generate-lockfile
        if: hashFiles('Cargo.lock') == ''
        run: cargo generate-lockfile
      - name: llvm-cov (${{ matrix.features }})
        run: |
          if [ "${{ matrix.features }}" == "default" ]; then
            cargo llvm-cov --locked --lcov --output-path lcov-${{ matrix.features }}.info --no-fail-fast -- --no-capture ${{ inputs.args }}
          else
            cargo llvm-cov --locked --features "${{ matrix.features }}" --lcov --output-path lcov-${{ matrix.features }}.info --no-fail-fast -- --no-capture ${{ inputs.args }}
          fi
        env:
          RUST_LOG: "${{ inputs.rustlog }}"
          RPC_URL: ${{ inputs.fireblocks && secrets.RPC_URL }}
          FIREBLOCKS_API_KEY: ${{ inputs.fireblocks && secrets.FIREBLOCKS_API_KEY }}
          FIREBLOCKS_SECRET: ${{ inputs.fireblocks && secrets.FIREBLOCKS_SECRET }}
          FIREBLOCKS_ENDPOINT: ${{ inputs.fireblocks && vars.FIREBLOCKS_ENDPOINT }}
          FIREBLOCKS_POLL_TIMEOUT: "90"
          FIREBLOCKS_POLL_INTERVAL: "5"
          FIREBLOCKS_DEVNET: "true"
          FIREBLOCKS_VAULT: "0"
          TEST_PRIVATE_KEY: ${{ inputs.fireblocks && secrets.TEST_PRIVATE_KEY }}
      - name: Record Rust version
        run: echo "RUST=$(rustc --version)" >> "$GITHUB_ENV"
      - name: Upload to codecov.io
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov-${{ matrix.features }}.info
          flags: ${{ matrix.features }}
          env_vars: OS,RUST
