name: Release
on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      package:
        type: string
        required: true
      cargo-release-args:
        type: string
        required: false
        default: ''
jobs:
  config:
    runs-on: ${{ inputs.runner || vars.RUNNER }}
    name: generate config
    outputs:
      config: ${{ steps.config.outputs.config }}
    steps:
      - name: config
        id: config
        uses: kiro-generator/ci/.github/actions/rust-config@main
        with:
          arm64: ${{ vars.RUNNER_ARM64 }}
          amd64: ${{ vars.RUNNER_AMD64 }}
          # win: "windows-latest"
          # mac: "macos-latest"
          git_token: ${{ github.token }}
  release:
    needs: [config]
    outputs:
      tag: ${{ steps.release.outputs.tag }}
    runs-on: ${{ vars.RUNNER }}
    permissions:
      contents: write
    steps:
      - name: Init
        uses: kiro-generator/ci/.github/actions/rust-init@main
        with:
          packages: ${{ toJSON(fromJSON(needs.config.outputs.config).global.packages) }}
      - name: Install cargo-release
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Release
        id: release
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NO_PUBLISH: ${{ fromJSON(needs.config.outputs.config).release.cargoPublish && '' || '--no-publish' }}
        run: |
          cargo release \
            --package ${{ inputs.package }} \
            --execute \
            --no-confirm ${NO_PUBLISH} \
            ${{ inputs.cargo-release-args }} ${{ inputs.version }}

          TAG=$(git describe --tags --abbrev=0)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          make_latest="true"
          case ${{ inputs.version }} in
            alpha|beta|rc)
              make_latest="false"
              prerelease="true"
              ;;
            *)
              make_latest="true"
              prerelease="false"
              ;;
          esac
          echo "make_latest=$make_latest" >> $GITHUB_OUTPUT
          echo "prerelease=$prerelease" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          generate_release_notes: true
          make_latest: ${{ steps.release.outputs.make_latest }}
          prerelease: ${{ steps.release.outputs.prerelease == 'true' }}
  bin:
    name: assets / ${{ matrix.target }}
    if: ${{ fromJSON(needs.config.outputs.config).release.bin }}
    needs: [config, release]
    strategy:
      matrix:
        include: ${{ fromJSON(toJSON(fromJSON(needs.config.outputs.config).release.os)) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Init / ${{ matrix.target }}
        uses: kiro-generator/ci/.github/actions/rust-init@main
        with:
          packages: ${{ toJSON(fromJSON(needs.config.outputs.config).global.packages) }}
          ref: ${{ needs.release.outputs.tag }}
      - name: Build / ${{ matrix.target }}
        id: build
        run: |
          if [ ${{ fromJSON(needs.config.outputs.config).release.debian }} == "true" ] && [ "${RUNNER_OS}" != "macOS" ]; then
            cargo install cargo-deb
            cargo deb --target ${{ matrix.target }}
            echo _dpkg="$(ls target/debian/*.deb)" >> $GITHUB_OUTPUT
          else
            cargo build --release --target ${{ matrix.target }}
          fi
          echo _bin=target/${{ matrix.target }}/release/${{ fromJSON(needs.config.outputs.config).release.bin }} >> $GITHUB_OUTPUT
      - name: Package / ${{ matrix.target }}
        run: |
          tar czf ${{ steps.build.outputs._bin }}-${{ matrix.target }}.tar.gz ${{ steps.build.outputs._bin }}
          sha256sum ${{ steps.build.outputs._bin }}-${{ matrix.target }}.tar.gz > ${{ steps.build.outputs._bin }}-${{ matrix.target }}.tar.gz.sha256
      - name: Hash Deb / ${{ matrix.target }}
        if: ${{ steps.build.outputs._dpkg }}
        run: |
          sha256sum  ${{ steps.build.outputs._dpkg }} > ${{ steps.build.outputs._dpkg }}.sha256
      - name: Upload / ${{ matrix.target }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag }}
          files: |
            ${{ steps.build.outputs._bin }}-${{ matrix.target }}.tar.gz
            ${{ steps.build.outputs._bin }}-${{ matrix.target }}.tar.gz.sha256
      - name: Deb Upload / ${{ matrix.target }}
        if: ${{ steps.build.outputs._dpkg }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag }}
          files: |
            ${{ steps.build.outputs._dpkg }}
            ${{ steps.build.outputs._dpkg }}.sha256
  homebrew:
    name: Update Homebrew tap
    if: ${{ fromJSON(needs.config.outputs.config).release.homebrew.if }}
    needs: [config, release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ fromJSON(needs.config.outputs.config).release.homebrew.repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Calculate source tarball SHA256
        id: sha
        run: |
          SHA=$(curl -sL https://github.com/${{ github.repository }}/archive/refs/tags/${{ needs.release.outputs.tag }}.tar.gz | shasum -a 256 | cut -d' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          
      - name: Update formula
        run: |
          sed -i 's|url ".*"|url "https://github.com/${{ github.repository }}/archive/refs/tags/${{ needs.release.outputs.tag }}.tar.gz"|' Formula/${{ inputs.package }}.rb
          sed -i 's|sha256 ".*"|sha256 "${{ steps.sha.outputs.sha256 }}"|' Formula/${{ inputs.package }}.rb
          
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/${{ inputs.package }}.rb
          git commit -m "Update ${{ inputs.package }} to ${{ needs.release.outputs.tag }}"
          git push
