name: jobtaker
on:
  workflow_call:
permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write
jobs:
  config:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@jobtaker')) ||
      (contains(github.event.pull_request.labels.*.name, 'jobtaker')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@jobtaker') || contains(github.event.issue.title, '@jobtaker')))
    runs-on: ${{ inputs.runner || vars.RUNNER }}
    name: generate config
    outputs:
      config: ${{ steps.config.outputs.config }}
    steps:
      - name: Validate ANTHROPIC_API_KEY
        shell: bash
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            exit 1
          fi
      - name: config
        id: config
        uses: kiro-generator/ci/.github/actions/rust-config@main
        with:
          arm64: ${{ vars.RUNNER_ARM64 }}
          amd64: ${{ vars.RUNNER_AMD64 }}
          git_token: ${{ github.token }}
  jobtaker:
    needs:  [config]
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@jobtaker')) ||
      (contains(github.event.pull_request.labels.*.name, 'jobtaker')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@jobtaker') || contains(github.event.issue.title, '@jobtaker')))
    runs-on: ${{ vars.RUNNER }}
    steps:
      - name: checkout
        uses: kiro-generator/ci/.github/actions/rust-init@main
        with:
          packages: ${{ toJSON(fromJSON(needs.config.outputs.config).global.packages) }}
      - uses: actions/cache@v5
        with:
          path: ./codecov
          key: codecov-${{ vars.RUNNER }}
      - name: codecov cli
        shell: bash
        run: |
          if [ ! -f ./codecov ]; then
            curl -v -L -O https://cli.codecov.io/latest/linux-arm64/codecov
          fi
          chmod +x ./codecov
          sudo cp -v  ./codecov /usr/local/bin
      - name: jobtaker
        if: ${{ fromJSON(needs.config.outputs.config).ai.enabled }}
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: '@jobtaker'
          settings: ${{ toJSON(fromJSON(needs.config.outputs.config).ai.claude_settings) }}
          label_trigger: 'jobtaker'
          allowed_bots: ${{ fromJSON(needs.config.outputs.config).ai.allowed_bots }}
          prompt: ${{ fromJSON(needs.config.outputs.config).ai.prompt }}
          claude_args: |
           --model ${{ fromJSON(needs.config.outputs.config).ai.model }} ${{ fromJSON(needs.config.outputs.config).ai.claude_args }}
          use_sticky_comment: ${{ fromJSON(needs.config.outputs.config).ai.use_sticky_comment }}
          track_progress: "${{ fromJSON(needs.config.outputs.config).ai.track_progress }}"
          path_to_claude_code_executable: ''
          path_to_bun_executable: ''
          show_full_output: 'false'
          plugins: ''
          plugin_marketplaces: ''

# When track_progress is enabled:
# - Creates a tracking comment with progress checkboxes
# - Includes all PR context (comments, attachments, images)
# - Updates progress as the review proceeds
# - Marks as completed when done
