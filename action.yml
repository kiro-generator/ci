name: ci-config
description: config ci config
author: dougEfresh
branding:
  icon: scissors
  color: black
outputs:
  config:
    description: JSON string of the config
    value: ${{ steps.generate.outputs.config }}
runs:
  using: composite
  steps:
    - uses: actions/cache@v5
      name: cache bun
      with:
        path: /home/runner/.bun
        key: bun-${{ vars.RUNNER }}
    - name: setup bun
      uses: oven-sh/setup-bun@v2
    - name: install
      shell: bash
      run: |
        cd ${{ github.action_path }}
        bun install
    - name: build
      shell: bash
      run: |
        cd ${{ github.action_path }}
        bun run build
    - id: prompt
      shell: bash
      run: |
        sed -e 's|%REPO%|${{ github.repository }}|g' -e 's|%PR%|${{ github.event.pull_request.number }}|g' \
          ${{ github.action_path }}/prompt-template.md >  ${{ github.action_path }}/claude-prompt.md
        if [ -f .github/agents/additional-prompt.md ]; then
          cat .github/agents/additional-prompt.md >> ${{ github.action_path }}/claude-prompt.md
        fi
    - id: generate
      name: generate
      shell: bash
      run: |
        if [ ! -f .github/rust-ci.ts ]; then
          echo "::error::Missing .github/rust-ci.ts config file"
          exit 1
        fi
        if [ .github/rust-ci.ts -ef ${{ github.action_path }}/.github/rust-ci.ts ]; then
          echo "Running in action repo, skipping copy"
        else
          cp -v .github/rust-ci.ts ${{ github.action_path }}/.github/
        fi
        cat ${{ github.action_path }}/.github/rust-ci.ts
        cd ${{ github.action_path }}
        CONFIG="$(bun run ./scripts/generate-rust.ts | jq . --compact-output )"
        echo "config=$CONFIG" >> $GITHUB_OUTPUT
